name: Publish Rust crates (crates.io)

on:
  push:
    tags:
      - "v*"

jobs:
  publish:
    runs-on: ubuntu-latest

    # Needed for OIDC -> crates.io token exchange
    permissions:
      id-token: write
      contents: read

    # Optional but recommended: match this in crates.io Trusted Publisher config
    environment: crates-io

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Verify versions match tag (vX.Y.Z)
        shell: bash
        run: |
          TAG="${GITHUB_REF_NAME}"
          VER="${TAG#v}"
          META="$(cargo metadata --format-version 1 --no-deps)"

          echo "tag version:   $VER"

          for pkg in \
            calib-targets-core \
            calib-targets-chessboard \
            calib-targets-aruco \
            calib-targets-charuco \
            calib-targets-marker \
            calib-targets; do
            PKG_VER="$(jq -r --arg name "$pkg" '.packages[] | select(.name==$name) | .version' <<<"$META")"
            echo "$pkg version:  $PKG_VER"
            test "$PKG_VER" = "$VER"
          done

      - name: Test workspace
        run: cargo test --workspace

      - name: Authenticate to crates.io via Trusted Publishing (OIDC)
        id: cratesio
        uses: rust-lang/crates-io-auth-action@v1

      - name: Publish calib-targets crates (retry)
        env:
          CARGO_REGISTRY_TOKEN: ${{ steps.cratesio.outputs.token }}
        shell: bash
        run: |
          publish_with_retry() {
            local pkg="$1"
            for attempt in 1 2 3 4 5 6 7 8 9 10; do
              echo "Attempt $attempt: publishing $pkg..."
              if cargo publish -p "$pkg" --locked; then
                return 0
              fi
              echo "Publish failed (likely waiting for index). Sleeping 20s..."
              sleep 20
            done
            echo "Failed to publish $pkg after retries."
            return 1
          }

          publish_with_retry calib-targets-core
          publish_with_retry calib-targets-chessboard
          publish_with_retry calib-targets-aruco
          publish_with_retry calib-targets-charuco
          publish_with_retry calib-targets-marker
          publish_with_retry calib-targets
